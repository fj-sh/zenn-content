---
title: "Cloud Functions + TypeScript ã®é–‹ç™ºã‚’å§‹ã‚ã‚‹"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

### node.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ

```console
npm init
gibo dump node >> .gitignore
echo "build" >> .gitignore
```

### Node.js ã® Functions Framework ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```console
npm install @google-cloud/functions-framework
```

å‚è€ƒï¼š[3. Install the Functions Framework for Node.js](https://codelabs.developers.google.com/codelabs/local-development-with-cloud-functions#3)

### TypeScript å¯¾å¿œ

```console
npx gts init
npm install @types/express concurrently nodemon --save-dev
```

package.json ã«ä»¥ä¸‹ã‚’è¿½åŠ ã€‚

```json
 "scripts": {
    "start": "functions-framework --source=build/src/ --target=helloWorld",
    "watch": "concurrently \"tsc -w\" \"nodemon --watch ./build/ --exec npm run start\"",
    ...
  }
```

`scr/index.ts` ã‚’ä»¥ä¸‹ã«ç½®ãæ›ãˆã‚‹ã€‚

```js:src/index.ts
import type { HttpFunction } from '@google-cloud/functions-framework/build/src/functions';

export const helloWorld: HttpFunction = (req, res) => {
  res.send('Hello, World');
};
```

å‚è€ƒï¼š[functions-framework-nodejs/docs/typescript.md](https://github.com/GoogleCloudPlatform/functions-framework-nodejs/blob/master/docs/typescript.md)

### ã¨ã‚Šã‚ãˆãšãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ã—ã¦ã¿ã‚‹

```console
npm run watch
```

`http://localhost:8080/`ã‚’é–‹ãã¨ã€ã€ŒHello Worldã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

### Cloud Functions ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

`package.json` ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```diff json:package.json
- "main": "index.js",
+ "main": "build/src/index.js",

- "prepare": "npm run compile",
```

ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```console
gcloud functions deploy helloWorld \
--runtime nodejs16 \
--trigger-http
```

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸ URL ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ `hello world` ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

### é–¢æ•°åã‚’`helloWorld` ã‹ã‚‰å¤‰æ›´ã™ã‚‹

ã“ã“ã¾ã§ã®æ‰‹é †ã§ã¯`src/index.ts`ã®é–¢æ•°ã¯ `helloWorld` ã¨ãªã£ã¦ã„ã¾ã™ã€‚

```js
import type { HttpFunction } from "@google-cloud/functions-framework/build/src/functions";

export const helloWorld: HttpFunction = (req, res) => {
  res.send("Hello, World");
};
```

é–¢æ•°åã‚’å¤‰æ›´ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¾ã™ã€‚

ãŸã¨ãˆã° `getTitles` ã«é–¢æ•°åã‚’å¤‰æ›´ã—ã¦ã¿ã¾ã™ã€‚

```js:src/index.ts
import type { HttpFunction } from '@google-cloud/functions-framework/build/src/functions';

export const getTitles: HttpFunction = (req, res) => {
  res.send('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ã—ã¾ã—ãŸã€‚');
};
```

`package.json`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```diff json:package.json
-  "start": "functions-framework --source=build/src/ --target=helloWorld",
+  "start": "functions-framework --source=build/src/ --target=getTitles",
```

```console
npm run clean
npm run compile

gcloud functions deploy getTitles \
--runtime nodejs16 \
--trigger-http
```

### CORS ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹

Ajax ã§å€¤ã‚’å–å¾—ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ãŒã‚¢ã‚«ãƒ³ï¼ã¿ãŸã„ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã¨æ€ã„ã¾ã™ã€‚

ãã†ã„ã†ã¨ãã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«`Access-Control-Allow-Origin`ã‚’è¨­å®šã™ã‚‹æ–¹æ³•ã‚‚ä½¿ãˆã¾ã™ã€‚
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒæ°—ã«ãªã‚‹æ–¹ã¯è¨­å®šã—ãªã„ã»ã†ãŒã„ã„ã§ã™ãŒã€‚

```js:src/index.ts
export const getTitles: HttpFunction = (req, res) => {
  res.set("Access-Control-Allow-Origin", "*")
  res.send('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ã—ã¾ã—ãŸã€‚');
};
```
