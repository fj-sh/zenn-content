---
title: "Rails6 + MySQLã®é–‹ç™ºç’°å¢ƒã‚’Dockerã§æ§‹ç¯‰ã™ã‚‹"
emoji: "ğŸ‘±â€â™‚ï¸"
type: "tech"
topics: ["rails"]
published: true
---

ä½•ç•ªç…ã˜ã‹ã¯ã‚ã‹ã‚Šã¾ã›ã‚“ãŒã€Railsã®é–‹ç™ºç’°å¢ƒã‚’Dockerã§æ§‹ç¯‰ã™ã‚‹æ‰‹é †ã‚’æ®‹ã—ã¾ã™ã€‚

- Rails 6.0.3.4
- MySQL 8.0.20
- Ruby 2.7.2

### å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç”¨æ„ã™ã‚‹

```
touch {Dockerfile,docker-compose.yml,Gemfile,Gemfile.lock,.env}
```


```shell
% tree -L 1
.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Gemfile
â”œâ”€â”€ Gemfile.lock
â”œâ”€â”€ docker-compose.yml
```

```shell:Dockerfile
FROM ruby:2.7.2

ENV LANG C.UTF-8
ENV APP_ROOT /app

WORKDIR /app

RUN apt-get update \
  && curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - \
  && echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list \
  && apt-get update -qq \
  && apt-get install -y nodejs yarn \
  && apt-get install -y sqlite3 \
  && apt-get install -y libsqlite3-dev \
  && apt-get install -y vim \
  && apt-get clean  \
# Capybaraã§ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªã‚‚ã®ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# ç½²åã‚’è¿½åŠ (chromeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¿…è¦) -> apt-getã§chromeã¨ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  && wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add \
  && echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | tee /etc/apt/sources.list.d/google-chrome.list \
  && apt-get update -qq \
  && apt-get install -y google-chrome-stable libnss3 libgconf-2-4 \
  && CHROMEDRIVER_VERSION=`curl -sS chromedriver.storage.googleapis.com/LATEST_RELEASE` \
  && curl -sS -o /tmp/chromedriver_linux64.zip http://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip \
  && unzip /tmp/chromedriver_linux64.zip \
  && mv chromedriver /usr/local/bin/ \
# Ruby-2.7ä»¥é™ã ã¨`gem install bundler`ã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹
  && gem install bundler

RUN mkdir -p $APP_ROOT
WORKDIR $APP_ROOT

COPY Gemfile $APP_ROOT/Gemfile
COPY Gemfile.lock $APP_ROOT/Gemfile.lock
RUN bundle update --bundler \
&& bundle install  --jobs 4 --retry 3
```

```docker:docker-compose.yml
version: '3'
services:
  db:
    image: mysql:8.0.20
    volumes:
      - ./tmp/db:/var/lib/mysql
    ports:
      - '3306:3306'
    command: --default-authentication-plugin=mysql_native_password
    env_file: .env

  web:
    build: .
    command: /bin/sh
    env_file: .env
    environment:
      WEBPACKER_DEV_SERVER_HOST: "0.0.0.0"
      RAILS_SERVE_STATIC_FILES: "1"
      EDITOR: "vim"
    volumes:
      - ./app:/app:cached
    ports:
      - "3000:3000"
    depends_on:
      - db
    tty: true
```

```env:.env
MYSQL_ROOT_PASSWORD=password
TZ=Japan
```

```ruby:Gemfile
source 'https://rubygems.org'
ruby '2.7.2'

gem 'rails', '6.0.3.4'
```

```ruby:Gemfile.lock
# Gemfile.lockã¯ç©º
```

## ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹

1ã¤ç›®ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```
$ docker-compose build --no-cache
$ docker-compose up
```


## Railsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹

åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```
$ docker-compose exec web bash
/app# rails -v
Rails 6.0.3.4
/app# rails new . --force --database=mysql --skip-turbolinks --skip-test
/app# bin/rails webpacker:install
```
- `--skip-test`: testã‚’ä½œæˆã—ãªã„ã€‚`--skip-test-unit`ã¨åŒã˜
- `--force`:ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¦ã„ã¦ã‚‚ä¸Šæ›¸ãã™ã‚‹


database.ymlã‚’ç·¨é›†ã—ã¾ã™ã€‚
```yml:config/database.yml
default: &default
  adapter: mysql2
  encoding: utf8mb4
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  username: <%= ENV.fetch('MYSQL_USERNAME') { 'root' } %>
  password: <%= ENV.fetch('MYSQL_PASSWORD') { 'password' } %>
  host: <%= ENV.fetch('MYSQL_HOST') { 'db' } %>

development:
  <<: *default
  database: app_development

test:
  <<: *default
  database: app_test

production:
  <<: *default
  database: app_production
  username: app
  password: <%= ENV['APP_DATABASE_PASSWORD'] %>
```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```
/app# bin/rails db:create
/app# bin/rails db:migrate
```

ã‚µãƒ¼ãƒã‚’èµ·å‹•ã—ã¾ã™ã€‚

```
/app# bin/rails s -b 0.0.0.0
```

ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰`http://localhost:3000/`ã‚’é–‹ãã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/ewc7ubalgtzghwewibd6gsqmu1jr)

å…¬å¼ã®ã‚„ã‚Šæ–¹ã¯ä¸‹è¨˜ã‚’å‚ç…§ã€‚

[ã‚¯ã‚£ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ: Compose ã¨ Rails](https://matsuand.github.io/docs.docker.jp.onthefly/samples/rails/)

## RSpecã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Gemfileã«rspecã¨factory_botã®gemã‚’åŠ ãˆã¾ã™ã€‚

```ruby:Gemfile
group :development, :test do
  # Call 'byebug' anywhere in the code to stop execution and get a debugger console
  gem 'byebug', platforms: [:mri, :mingw, :x64_mingw]
  gem 'rspec-rails'
  gem 'factory_bot_rails'
end
```

Railsã‚¢ãƒ—ãƒªã«RSpecã‚’å°å…¥ã—ã¾ã™ã€‚
```
/app# bundle exec rails g rspec:install
Running via Spring preloader in process 1096
      create  .rspec
      create  spec
      create  spec/spec_helper.rb
      create  spec/rails_helper.rb
```