---
title: "Active Jobã«ã‚ˆã‚‹éåŒæœŸå®Ÿè¡Œ"
emoji: "ğŸ“‘"
type: "tech"
topics: ["rails"]
published: true
---

Active Jobã¯éåŒæœŸå®Ÿè¡Œå‡¦ç†æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
Rails4.2ã‹ã‚‰è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚

æ™‚é–“ãŒã‹ã‹ã‚‹å‡¦ç†ã«ã‚ˆã‚Šã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã¾ã§ã®æ™‚é–“ãŒé•·ããªã£ã¦ã—ã¾ã†ã¨ãã«ã¯ã€å…ˆã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¦ãŠãã€é•·ã„æ™‚é–“ãŒã‹ã‹ã‚‹å‡¦ç†ã‚’éåŒæœŸã«åˆ¥é€”å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ—©ãå¿œç­”ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## ã‚¸ãƒ§ãƒ–ã®å®Ÿè£…

éåŒæœŸã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ã‚’ä½œã£ã¦ã¿ã‚‹ã€‚

```
/app# bin/rails g model async_display message
/app# bin/rails db:migrate
```

```ruby:models/async_display.rb
class AsyncDisplay < ApplicationRecord
  def self.console(message)
    puts "#{message}"
  end
end
```

### ã‚¸ãƒ§ãƒ–ã‚¯ãƒ©ã‚¹ã‚’ç”Ÿæˆã™ã‚‹

```
# bin/rails g job async_display
```

```ruby:async_display_job.rb
class AsyncDisplayJob < ApplicationJob
  queue_as :default

  def perform(message: "hello async job!")
    AsyncDisplay.console(message: message)
  end
end
```

### Railsã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿé¨“ã—ã¦ã¿ã‚‹

```
> AsyncDisplayJob.perform_later(message: "Yahoo!")

Enqueued AsyncDisplayJob (Job ID: ab336b37-85df-40b2-b0fc-15d9c12187e1) to Async(default) with arguments: {:message=>"Yahoo!"}
=> #<AsyncDisplayJob:0x00007fc32c3c9ff0 @arguments=[{:message=>"Yahoo!"}], @job_id="ab336b37-85df-40b2-b0fc-15d9c12187e1", @queue_name="default", @priority=nil, @executions=0, @exception_executions={}, @provider_job_id="45512861-0415-49ba-be0f-71241e7eff18">
Performing AsyncDisplayJob (Job ID: ab336b37-85df-40b2-b0fc-15d9c12187e1) from Async(default) enqueued at 2021-04-26T11:25:58Z with arguments: {:message=>"Yahoo!"}
{:message=>"Yahoo!"}
irb(main):008:0> Performed AsyncDisplayJob (Job ID: ab336b37-85df-40b2-b0fc-15d9c12187e1) from Async(default) in 0.26ms
```

15ç§’å¾Œã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã•ã›ã¦ã¿ã‚‹ã€‚
```
> AsyncDisplayJob.set(wait: 15.seconds).perform_later(message: "Yahoo!")

Enqueued AsyncDisplayJob (Job ID: f776af33-99cb-42e9-9ece-82b7fd6d75d7) to Async(default) at 2021-04-26 11:27:12 UTC with arguments: {:message=>"Yahoo!"}
=> #<AsyncDisplayJob:0x00007fc32c6404f0 @arguments=[{:message=>"Yahoo!"}], @job_id="f776af33-99cb-42e9-9ece-82b7fd6d75d7", @queue_name="default", @priority=nil, @executions=0, @exception_executions={}, @provider_job_id="3b8e7d70-7027-4f59-bc98-3077183e9ce6", @scheduled_at=1619436432.650006>

## ... 15ç§’å¾Œ ...
> Performing AsyncDisplayJob (Job ID: f776af33-99cb-42e9-9ece-82b7fd6d75d7) from Async(default) enqueued at 2021-04-26T11:26:57Z with arguments: {:message=>"Yahoo!"}
{:message=>"Yahoo!"}
Performed AsyncDisplayJob (Job ID: f776af33-99cb-42e9-9ece-82b7fd6d75d7) from Async(default) in 0.2ms
```

## Delayed Jobã‚’å®Ÿè£…ã™ã‚‹

Gemfileã«`delayed_job_active_record`ã‚’è¿½åŠ ã—ã¦ã‹ã‚‰`bundle install`ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

```ruby:Gemfile
gem 'delayed_job_active_record'
gem 'daemons'
```

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚
```
/app# rails g delayed_job:active_record
```

ã™ã‚‹ã¨`/bin`ä»¥ä¸‹ã«`delayed_job`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚

```ruby:bin/delayed_job
#!/usr/bin/env ruby

require File.expand_path(File.join(File.dirname(__FILE__), '..', 'config', 'environment'))
require 'delayed/command'
Delayed::Command.new(ARGV).daemonize
```

å¿…è¦ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚
```
/app# bin/rails db:migrate
```

ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹ã¨`delayed_jobs`ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
```ruby
create_table "delayed_jobs", options: "ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.integer "priority", default: 0, null: false
    t.integer "attempts", default: 0, null: false
    t.text "handler", null: false
    t.text "last_error"
    t.datetime "run_at"
    t.datetime "locked_at"
    t.datetime "failed_at"
    t.string "locked_by"
    t.string "queue"
    t.datetime "created_at", precision: 6
    t.datetime "updated_at", precision: 6
    t.index ["priority", "run_at"], name: "delayed_jobs_priority"
  end
```

## delayed_jobã®èµ·å‹•ã¨åœæ­¢

```
/app# bin/delayed_job start
delayed_job: process with pid 2093 started.
root      2093  1.4  3.7 631036 75692 ?        Sl   00:01   0:00 delayed_job

/app# bin/delayed_job stop
```

## ä½¿ã£ã¦ã¿ã‚‹

- å‘½ä»¤ã‚’ä½œã‚‹
- å‘½ä»¤ã‚’éåŒæœŸã§å®Ÿè¡Œã™ã‚‹

ã¨ã„ã†ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ã€‚

![](https://storage.googleapis.com/zenn-user-upload/sssef19n66s3upw5lk4kpbrx54av)

å‘½ä»¤ã‚’å…¥åŠ›ã—ã¦ã€å®Ÿè¡Œã™ã‚‹ã€‚

![](https://storage.googleapis.com/zenn-user-upload/3qom02etqu01qf3qc66m00xwf4vb)

`config/application.rb`ã‚’ç·¨é›†ã—ã€ä»¥ä¸‹ã‚’è¿½è¨˜ã™ã‚‹ã€‚

```ruby:config/application.rb
config.active_job.queue_adapter = :delayed_job
```

```
/app# bin/rails g controller Commands new create index
/app# bin/rails g model Command name:string

# bin/rails db:migrateã§ã‚‚OK
/app# bundle exec rake db:migrate
```

delayed_jobã¯éåŒæœŸå®Ÿè¡Œã—ãŸã„ãƒ¡ã‚½ãƒƒãƒ‰ã«`delay`ã‚’ã¤ã‘ã¦å‘¼ã³å‡ºã™ã€‚

```ruby:app/controllers/commands_controller.rb
class CommandsController < ApplicationController
  def new
    @command = Command.new
  end

  def create
    puts "create called."
    command = Command.new(command_params)
    Command.delay.execute_command(command.name)
    redirect_to commands_url, notice: "å‘½ä»¤ã€Œ#{command.name}ã€ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚"
  end

  def index
  end

  private

  def command_params
    params.require(:command).permit(:name)
  end
end
```

```ruby:app/models/command.rb
class Command < ApplicationRecord

  def self.execute_command(name="hello")
    name << "_#{Time.now.strftime("%H%M%S")}"
    sleep rand(1..5)
    puts "Command [#{name}] ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚"
  end
end
```

```erb:app/views/commands/new.html.erb
<h1>Create Command</h1>
<%= form_with model: @command, url: :commands, local: true do |f| %>

  name:<%= f.text_field :name %>
  <br/>
  <%= f.submit "ç™»éŒ²" %>
<% end %>
```
```erb:app/views/commands/index.html.erb
<h1>Command#index</h1>
<% if flash.notice.present? %>
  <%= flash.notice %>
<% else %>
  å‘½ä»¤ã¯ã‚ã‚Šã¾ã›ã‚“ã‚ˆ
<% end %>

<%= link_to "å‘½ä»¤ã‚’ä½œã‚‹", commands_new_path %>
```

é©å½“ã«å‘½ä»¤ã‚’ä½œã£ãŸã‚ã¨ã§ã€`rails console`ã§ç¢ºèªã—ã¦ã¿ã‚‹ã€‚

```
/app# rails c
> Delayed::Job.last.invoke_job
  Delayed::Backend::ActiveRecord::Job Load (0.9ms)  SELECT `delayed_jobs`.* FROM `delayed_jobs` ORDER BY `delayed_jobs`.`id` DESC LIMIT 1
Command [acdcd_002653] ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚
```


## å‚è€ƒ

[Rails4ã§ã‚µã‚¤ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ â€“ éåŒæœŸå‡¦ç†ç·¨(delayed_job)](https://techracho.bpsinc.jp/kazumasa-ogawa/2014_09_25/17541)
[ã€Railsã€‘delayed_jobã®enqueueæ–¹æ³•ã¨queue(éåŒæœŸå‡¦ç†)å®Ÿè¡Œæ–¹æ³•ã«ã¤ã„ã¦ã¾ã¨ã‚](https://shirusu-ni-tarazu.hatenablog.jp/entry/2014/05/08/040156)