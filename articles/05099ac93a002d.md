---
title: "Next.js ã‹ã‚‰ Azure Event Hubs ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ã£ã¦ã¿ã‚‹"
emoji: "ğŸ¦”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["azure"]
published: true
---

Next.js ã‹ã‚‰ Azure Event Hubs ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ã‚‹ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚

`npx create-next-app@latest --typescript` ã§ Next.js ã®é››å½¢ã‚’ä½œã‚Šã¾ã™ã€‚

Next.js ã®[ç’°å¢ƒå¤‰æ•°](https://nextjs-ja-translation-docs.vercel.app/docs/basic-features/environment-variables) ã« Azure Event Hubs ã¸ã®æ¥ç¶šæ–‡å­—åˆ—ã‚’è¨­å®šã—ã¾ã™ã€‚ `.env.local` ã‚’ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä½œæˆã—ã¾ã™ã€‚

```bash:.env.local
NEXT_PUBLIC_EVENTHUB_CONNECTION_STRING="Endpoint=sb://xxxx"
NEXT_PUBLIC_EVENTHUB_NAME="event-hub-name"
```

`hooks` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã‚Šã€`hooks/useEventHub.ts` ã‚’ä½œã‚Šã¾ã™ã€‚

```js:hooks/useEventHub.ts
import { EventHubProducerClient } from "@azure/event-hubs";

export const useEventHub =  () => {
  const connectEventHub = async() => {
    const connectionString = process.env.NEXT_PUBLIC_EVENTHUB_CONNECTION_STRING
    const eventHubName =  process.env.NEXT_PUBLIC_EVENTHUB_NAME

    if (connectionString != null && eventHubName != null) {
      const producer = new EventHubProducerClient(connectionString, eventHubName)
      const batch = await producer.createBatch();
      batch.tryAdd({ body: { "message": "Hello World" }})
      await producer.sendBatch(batch)
      await producer.close()
      console.log('ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚')
    }
  }
  return { connectEventHub }
}
```

ã“ã® Hooks ã‚’ä½¿ã£ã¦ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¥‘æ©Ÿã« Azure Event Hubs ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Azure Event Hubs ã«é€ä¿¡ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã§ã¯ã€

```json
{
  "body": {
    "message": "hello world"
  }
}
```

ã®ã‚ˆã†ã«ã€`body` ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨ã—ã¦ä»»æ„ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®šã§ãã¾ã™ã€‚

é€ä¿¡ã™ã‚‹å´ã¨å—ä¿¡ã™ã‚‹å´ã§ã‚¤ãƒ™ãƒ³ãƒˆã®å‹ã‚’å…±æœ‰ã—ã¦ãŠãã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

[Azure Event Hubs client library for JavaScript - Version 5.6.0](https://docs.microsoft.com/en-us/javascript/api/overview/azure/event-hubs-readme?view=azure-node-latest)

## ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ã™ã‚‹

ã‚µãƒ³ãƒ—ãƒ«ãã®ã¾ã¾ã§ã™ãŒã€ã©ã“ã®æ–‡å­—åˆ—ã‚’ä½•ã«è¨­å®šã™ã‚‹ã®ã‹ãŒã‚ã‹ã‚Šã¥ã‚‰ã‹ã£ãŸã‹ã¨æ€ã„ã¾ã™ã®ã§ã€ãã®è¾ºã‚’ã‚ã‹ã‚‹ã‚ˆã†ã«æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚
ã‚³ãƒ¼ãƒ‰ã¯é›‘ãªã®ã§ã€ã‚‚ã—ã“ã®è¨˜äº‹ã‚’è¦‹ãŸæ–¹ãŒã„ãŸã‚‰ã€é©å®œæ›¸ãç›´ã—ã¦ä½¿ã£ã¦ãã ã•ã„ã€‚

```js
const { EventHubConsumerClient } = require("@azure/event-hubs");
const { ContainerClient } = require("@azure/storage-blob");
const {
  BlobCheckpointStore,
} = require("@azure/eventhubs-checkpointstore-blob");

const connectionString =
  "Event Hubs åå‰ç©ºé–“ - è¨­å®š - å…±æœ‰ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ - é¸æŠã—ãŸãƒãƒªã‚·ãƒ¼ ã®ã€Œæ¥ç¶šæ–‡å­—åˆ— - ä¸»ã‚­ãƒ¼ã€";
const eventHubName =
  "Event Hubs åå‰ç©ºé–“ - ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ - EventHubs ã®ã€Œåå‰ã€åˆ—ã«ã‚ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ–";

const consumerGroup = "$Default"; // name of the default consumer groupï¼ˆã“ã“ã®å€¤ã¯ã‚ˆãã‚ã‹ã‚‰ãªã‹ã£ãŸï¼‰
const storageConnectionString =
  "ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ - å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€ - ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ ã® key1 ã®æ¥ç¶šæ–‡å­—åˆ— DefaultEndpointsProtocol=...ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã‚‚ã®";

const containerName =
  "ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ - å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã€ - ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ ã®ã€Œåå‰ã€ã®åˆ—ã«ã‚ã‚‹åå‰";

async function main() {
  console.log("Receiving...");
  const containerClient = new ContainerClient(
    storageConnectionString,
    containerName
  );
  const checkpointStore = new BlobCheckpointStore(containerClient);
  const consumerClient = new EventHubConsumerClient(
    consumerGroup,
    connectionString,
    eventHubName,
    checkpointStore
  );

  const subscription = consumerClient.subscribe({
    processEvents: async (events, context) => {
      if (events.length === 0) {
        console.log(
          `No events received within wait time. Waiting for next interval`
        );
        return;
      }

      for (const event of events) {
        console.log("event:", event);
        console.log(
          `Received event: '${event.body.message}' from partition: '${context.partitionId}' and consumer group: '${context.consumerGroup}'`
        );
      }

      await context.updateCheckpoint(events[events.length - 1]);
    },
    processError: async (err, context) => {
      console.log(`Error: ${err}`);
    },
  });

  await new Promise((resolve) => {
    setTimeout(async () => {
      await subscription.close();
      await consumerClient.close();
      resolve();
    }, 60000);
  });
}

main().catch((err) => {
  console.log("Error occurred: ", err);
});
```

ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```console
event: {
  body: { message: 'Hello World' },
  properties: {},
  offset: '2144',
  sequenceNumber: 23,
  enqueuedTimeUtc: 2022-01-10T12:52:56.888Z,
  partitionKey: undefined,
  systemProperties: {},
  getRawAmqpMessage: [Function: getRawAmqpMessage]
}
Received event: 'Hello World' from partition: '1' and consumer group: '$Default'

```
