---
title: "[Rails]Delayed::Jobã‚’ä½¿ã£ã¦ã¿ã‚‹"
emoji: "ğŸ£"
type: "tech"
topics: ["rails"]
published: true
---

è·å ´ã®Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§Delayed::Jobã‚’ä½¿ã£ã¦ã„ã‚‹éƒ¨åˆ†ãŒã‚ã£ãŸã®ã§ã€æ”¹ã‚ã¦è‡ªåˆ†ã§ã‚‚è§¦ã£ã¦ã¿ã¾ã™ã€‚

Gemfileã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```ruby:Gemfile
gem 'delayed_job_active_record'
```

å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚

```
% bundle instal
% rails generate delayed_job:active_record
% rake db:migrate
```

`config/application.rb`ã‚’ç·¨é›†ã—ã¾ã™ã€‚

```diff ruby:config/application.rb
module ActiveJobExample
  class Application < Rails::Application
    config.load_defaults 6.0

+    config.active_job.queue_adapter = :delayed_job
```

ãƒ¢ãƒ‡ãƒ«ã‚’ä½œã£ã¦ã¿ã¾ã™ã€‚

```
% bin/rails g model User name:string email:string
% bin/rails db:migrate
```

```ruby:models/user.rb
# == Schema Information
#
# Table name: users
#
#  id         :integer          not null, primary key
#  email      :string
#  name       :string
#  created_at :datetime         not null
#  updated_at :datetime         not null
#
class User < ApplicationRecord

  def send_newsletter
    puts 'From send newsletter: ' + "example@example.com"
  end
end

```

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ä½œã‚Šã¾ã™ã€‚

```
% bin/rails g controller index index
```

```ruby:controllers/index_controller
class IndexController < ApplicationController
  def index
    u = User.new
    u.save!

    u.delay.send_newsletter
  end
end
```

ã“ã‚Œã§`index/index`ã‚’é–‹ã‘ã°jobã‚’queueã«pushã§ãã¾ã™ã€‚

jobã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«workerã‚’èµ·å‹•ã•ã›ã¾ã™ã€‚

```
% rake jobs:work
```

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```
[Worker(host:MacBook-Pro.local pid:56027)] Starting job worker
[Worker(host:MacBook-Pro.local pid:56027)] Job User#send_newsletter (id=6) RUNNING
From send newsletter: example@example.com
[Worker(host:MacBook-Pro.local pid:56027)] Job User#send_newsletter (id=6) COMPLETED after 0.0047
```

ä»¥ä¸‹ã®ã‚ˆã†ã« `run_at`ãªã©ã‚’ä½¿ãˆã°ã€ã€Œ1åˆ†å¾Œã«jobã‚’å®Ÿè¡Œã™ã‚‹ã€ãªã©ã®ä½¿ã„æ–¹ãŒã§ãã¾ã™ã€‚

```ruby
u.delay(run_at: 1.minutes.from_now).send_newsletter
```

#### å‚è€ƒ

[collectiveidea/delayed_job](https://github.com/collectiveidea/delayed_job)
[Delayed Job (DJ)](https://devcenter.heroku.com/ja/articles/delayed-job)