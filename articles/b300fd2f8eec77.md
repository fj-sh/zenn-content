---
title: "RSpecã§Railsã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹"
emoji: "ğŸ˜º"
type: "tech"
topics: ["rails"]
published: true
---

ã€Ruby on Rails 5ã®ä¸Šæ‰‹ãªä½¿ã„æ–¹ã€ã®ç¬¬6ç« ã«RSpecã®æ›¸ãæ–¹ãŒç´¹ä»‹ã•ã‚Œã¦ã„ãŸã®ã§ã€å†…å®¹ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

Railsã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ãŸç›´å¾Œã®å‰æã§é€²ã‚ã¾ã™ã€‚

## äº‹å‰æº–å‚™

Gemfileã«ä»¥ä¸‹ã‚’è¿½è¨˜ã—ã¦ã€ `bundle install` ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```ruby:Gemfile
group :development, :test do
  # Call 'byebug' anywhere in the code to stop execution and get a debugger console
  gem 'byebug', platforms: [:mri, :mingw, :x64_mingw]
  gem 'rspec-rails'
  gem 'factory_bot_rails'
  gem 'database_cleaner'
  gem 'faker'
  gem 'pry-rails'
  gem 'pry-coolline', github: 'owst/pry-coolline', branch: 'support_new_pry_config_api'
end
```

RSpecã®å®Ÿè¡Œã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```
% bin/rails g rspec:install
% bundle exec rspec
```

## DatabaseCleanerã‚’è¨­å®šã™ã‚‹

```ruby:spec/rails_helper.rb
RSpec.configure do |config|

  config.before(:suite) do
    DatabaseCleaner.strategy = :transaction
    DatabaseCleaner.clean_with(:trunsaction)
  end

  config.around(:each) do |example|
    DatabaseCleaner.cleaning do
      example.run
    end
  end
end
```

## FactoryBotã‚’è¨­å®šã™ã‚‹

`spec/rails_helper.rb`ã®`RSpec.configureãƒ–ãƒ­ãƒƒã‚¯å†…ã®æœ€å¾Œã«ä»¥ä¸‹ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```ruby:spec/rails_helper.rb
config.include FactoryBot::Syntax::Methods
```

## ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ¢ãƒ‡ãƒ«ã‚’æ›¸ã

```
% bin/rails g model Article title:text body:text status:integer published_at:datetime
% bundle exec rake db:migrate RAILS_ENV=test
```

```ruby:app/models/article.rb
class Article < ApplicationRecord
  enum status: { draft: 0, published: 1 }

  def abbreviated_title
    title.size >= 20 ? "#{title.slice(0, 19)}..." : title
  end

  def publish
    return if self.published?
    # https://railsguides.jp/active_record_basics.html#update
    update({status: Article.statuses['published'], published_at: Time.current})
  end
end
```

## describeãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹

```ruby:spec/models/article_spec.rb
require 'rails_helper'

RSpec.describe Article, type: :model do
  describe '.abbreviated_title' do
    it 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ãŒãã®ã¾ã¾è¿”ã‚‹ã“ã¨' do
      article = Article.new(title: 'ã‚¿ã‚¤ãƒˆãƒ«ã§ã™')
      expect(article.abbreviated_title).to eq 'ã‚¿ã‚¤ãƒˆãƒ«ã§ã™'
    end
  end
  
  describe '.publish' do
    it 'è¨˜äº‹ãŒå…¬é–‹çŠ¶æ…‹ã«ãªã‚‹ã“ã¨' do
      article = Article.new(status: :draft)
      expect(article.draft?).to be_truthy
      article.publish
      expect(article.published?).to be_truthy
    end
  end
end
```

`describe`ã§ãƒ¡ã‚½ãƒƒãƒ‰åã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
ãƒ¡ã‚½ãƒƒãƒ‰åã®å‰ã«ã¤ã„ã¦ã„ã‚‹`.`ã§ã™ãŒã€Rubyã§ã¯ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã®åå‰ã«ã¯`.`ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã®åå‰ã«ã¯`#`ã‚’ä½¿ã†ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚

`.`ã‚„`#`ã‚’ä»˜ã‘ã‚‹ã‹ã©ã†ã‹ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‘½åè¦å‰‡ã«ã‚ˆã‚Šã¾ã™ã€‚

`it` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è‡ªä½“ã‚’å®šç¾©ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚`it` ã§å®šç¾©ã•ã‚ŒãŸã‚‚ã®ã¯ exampleï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰ã¨å‘¼ã°ã‚Œã¾ã™ã€‚

## contextãƒ¡ã‚½ãƒƒãƒ‰ã§çŠ¶æ³ã‚’æ˜ç¢ºã«ã™ã‚‹

`context`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ã‚µãƒ³ãƒ—ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹çŠ¶æ³ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚
`context`ãƒ¡ã‚½ãƒƒãƒ‰ã¯åŒã˜çŠ¶æ³ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã§ãã¾ã™ã€‚

```ruby:spec/article_spec.rb
require 'rails_helper'

RSpec.describe Article, type: :model do
  describe '.abbreviated_title' do
    context 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ãŒ20å­—æœªæº€ã®å ´åˆ' do
      it 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ãŒãã®ã¾ã¾è¿”ã‚‹ã“ã¨' do
        article = Article.new(title: 'ã‚¿ã‚¤ãƒˆãƒ«ã§ã™')
        expect(article.abbreviated_title).to eq 'ã‚¿ã‚¤ãƒˆãƒ«ã§ã™'
      end
    end
    
    context 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ãŒ20å­—ä»¥ä¸Šã®å ´åˆ' do
      it 'ã‚¿ã‚¤ãƒˆãƒ«ãŒçœç•¥ã•ã‚Œã‚‹ã“ã¨' do
        article = Article.new(title: '20å­—ä»¥ä¸Šã®ã‚¿ã‚¤ãƒˆãƒ«ã¯é•·ã„ãœãˆã€‚çœç•¥ã•ã‚Œã‚‹ãœãˆ')
        expect(article.abbreviated_title).to eq '20å­—ä»¥ä¸Šã®ã‚¿ã‚¤ãƒˆãƒ«ã¯é•·ã„ãœãˆã€‚çœç•¥ã•...'
      end
    end
  
  end
  
  describe '.publish' do
    
    context 'è¨˜äº‹ãŒéå…¬é–‹çŠ¶æ…‹ã®å ´åˆ' do
      it 'è¨˜äº‹ãŒå…¬é–‹çŠ¶æ…‹ã«ãªã‚‹ã“ã¨' do
        article = Article.new(status: :draft)
        expect(article.draft?).to be_truthy
        article.publish
        expect(article.published?).to be_truthy
      end
    end
    
    context 'è¨˜äº‹ãŒå…¬é–‹çŠ¶æ…‹ã®å ´åˆ' do
      it 'è¨˜äº‹ãŒå…¬é–‹çŠ¶æ…‹ã®ã¾ã¾ã§ã‚ã‚‹ã“ã¨' do
        article = Article.new(status: :published)
        expect(article.published?).to be_truthy
        article.publish
        expect(article.published?).to be_truthy
      end
    end
    
  end
end
```

## ä½¿ç”¨é »åº¦ã®é«˜ã„matcher

|ãƒ¡ã‚½ãƒƒãƒ‰|æ¦‚è¦|ä½¿ã„æ–¹|
| --- | --- | --- |
| to | ã€œã§ã‚ã‚‹ã“ã¨| `expect(1 + 2).to eq 3` |
| not_to / to_not| ã€œã§ã¯ãªã„ã“ã¨| `expect(1 + 2).not_to eq 1` |
| eq| æœŸå¾…å€¤ã¨å®Ÿéš›ã®å€¤ãŒç­‰ã—ã„ã‹ã©ã†ã‹ | `expect(1 + 2).to eq 3` |
| be |å€¤ã®å¤§å°ã‚’æ¯”è¼ƒã™ã‚‹| `expect(1 + 2).to be >= 3` |
| be_xxxx |æˆ»ã‚Šå€¤ãŒtrue/falseã«ãªã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¤œè¨¼ã™ã‚‹| expect(user).to be_valid |
| be_truthy / be_falsey | æˆ»ã‚Šå€¤ã¨ã—ã¦true/falseã‚’è¿”ã™ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¤œè¨¼ã™ã‚‹ | expect(user.save).to be_truthy |
| change | ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŒ‡å®šã—ãŸå¾Œã«ã€æŒ‡å®šã®å€¤ãŒä½•ã‹ã‚‰ä½•ã¸å¤‰åŒ–ã™ã‚‹ã‹ã‚’æ¤œè¨¼ã™ã‚‹ | `expect{ x.pop }.to change{ x.size }.by(-1)` |


[ä½¿ãˆã‚‹RSpecå…¥é–€ãƒ»ãã®2ã€Œä½¿ç”¨é »åº¦ã®é«˜ã„ãƒãƒƒãƒãƒ£ã‚’ä½¿ã„ã“ãªã™ã€](https://qiita.com/jnchito/items/2e79a1abe7cd8214caa5)

## äº‹å‰å‡¦ç†ã€äº‹å¾Œå‡¦ç†ãŒã§ãã‚‹ãƒ•ãƒƒã‚¯

|ãƒ•ãƒƒã‚¯|æŒ¯ã‚‹èˆã„|
| --- | --- |
| before | ã‚µãƒ³ãƒ—ãƒ«å®Ÿè¡Œå‰ã«å®Ÿè¡Œã•ã‚Œã‚‹ |
| after | ã‚µãƒ³ãƒ—ãƒ«å®Ÿè¡Œå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ |
| around | ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã§ã‚µãƒ³ãƒ—ãƒ«ã®å®Ÿè¡Œã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ã‚“å«ã‚ã¦å®šç¾©ã—ã€å®Ÿè¡Œã•ã‚Œã‚‹ |

| ãƒ•ãƒƒã‚¯ã‚¹ã‚³ãƒ¼ãƒ— | æŒ¯ã‚‹èˆã„ |
| --- | --- |
| each, example | exampleã”ã¨ã«å®Ÿè¡Œã•ã‚Œã‚‹ |
|all, context | describe ãƒ¡ã‚½ãƒƒãƒ‰ã€ context ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«å®Ÿè¡Œã•ã‚Œã‚‹ |
| suite | RSpec å®Ÿè¡Œæ™‚ã« 1åº¦ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹ã€‚ rails_helper.rb ã‚„ spec_helper.rb ãªã©ã®ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã§å®šç¾©ã™ã‚‹ |

## pendingã¨skip

pending ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€Œã©ã†ã—ã¦ã‚‚è½ã¡ã¦ã—ã¾ã†ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹ã‹ã‚‰ä¿ç•™ã€ã¨ã„ã†ã¨ãã«ä½¿ã„ã¾ã™ã€‚
skip ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã‚³ãƒ¼ãƒ«ã•ã‚ŒãŸã¨ã“ã‚ã§å‡¦ç†ãŒä¸­æ–­ã•ã‚Œã€çµæœã«ä¿ç•™ã®ã€Œ*ã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

## é…å»¶è©•ä¾¡ã® let ã‚’ä½¿ã£ã¦ã¿ã‚‹

é…å»¶è©•ä¾¡ã¨ã¯ã€å®Ÿè¡Œã•ã‚ŒãŸã¨ãã«åˆã‚ã¦è©•ä¾¡ã•ã‚Œã‚‹ã¨ã„ã†ä»•çµ„ã¿ã§ã™ã€‚
`let` ã¯å¿…è¦ã«ãªã‚‹ç¬é–“ã¾ã§å‘¼ã³å‡ºã•ã‚Œã¾ã›ã‚“ã€‚

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ä»£ã‚ã‚Šã« `let` ã‚’ä½¿ã†ã‚±ãƒ¼ã‚¹ãŒå¤šã„ã§ã—ã‚‡ã†ã€‚

```ruby:spec/models/article_spec.rb
require 'rails_helper'

RSpec.describe Article, type: :model do
  describe '.abbreviated_title' do
    let(:article) { Article.new(title: title) }
    context 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ãŒ20å­—æœªæº€ã®å ´åˆ' do
      let(:title) { 'ã‚¿ã‚¤ãƒˆãƒ«ã§ã™' }
      it 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ãŒãã®ã¾ã¾è¿”ã‚‹ã“ã¨' do
        expect(article.abbreviated_title).to eq 'ã‚¿ã‚¤ãƒˆãƒ«ã§ã™'
      end
    end
    
    context 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ãŒ20å­—ä»¥ä¸Šã®å ´åˆ' do
      let(:title) { '20å­—ä»¥ä¸Šã®ã‚¿ã‚¤ãƒˆãƒ«ã¯é•·ã„ãœãˆã€‚çœç•¥ã•ã‚Œã‚‹ãœãˆ' }
      it 'ã‚¿ã‚¤ãƒˆãƒ«ãŒçœç•¥ã•ã‚Œã‚‹ã“ã¨' do
        expect(article.abbreviated_title).to eq '20å­—ä»¥ä¸Šã®ã‚¿ã‚¤ãƒˆãƒ«ã¯é•·ã„ãœãˆã€‚çœç•¥ã•...'
      end
    end
  end
end
```

[ä½¿ãˆã‚‹RSpecå…¥é–€ãƒ»ãã®1ã€ŒRSpecã®åŸºæœ¬çš„ãªæ§‹æ–‡ã‚„ä¾¿åˆ©ãªæ©Ÿèƒ½ã‚’ç†è§£ã™ã‚‹ã€](https://qiita.com/jnchito/items/42193d066bd61c740612)

## subject ã§ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚’æ˜ç¢ºã«ã™ã‚‹

`subject` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ãˆã°ã€`expect` ãƒ¡ã‚½ãƒƒãƒ‰ã§æŒ‡å®šã—ã¦ã„ãŸãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚’çœç•¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ruby:spec/models/article_spec.rb
    let(:article) { Article.new(title: title) }
    subject { article.abbreviated_title }
    context 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ãŒ20å­—æœªæº€ã®å ´åˆ' do
      let(:title) { 'ã‚¿ã‚¤ãƒˆãƒ«ã§ã™' }
      it 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ãŒãã®ã¾ã¾è¿”ã‚‹ã“ã¨' do
        is_expected.to eq 'ã‚¿ã‚¤ãƒˆãƒ«ã§ã™'
      end
    end
    
    context 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ãŒ20å­—ä»¥ä¸Šã®å ´åˆ' do
      let(:title) { '20å­—ä»¥ä¸Šã®ã‚¿ã‚¤ãƒˆãƒ«ã¯é•·ã„ãœãˆã€‚çœç•¥ã•ã‚Œã‚‹ãœãˆ' }
      it 'ã‚¿ã‚¤ãƒˆãƒ«ãŒçœç•¥ã•ã‚Œã‚‹ã“ã¨' do
        is_expected.to eq '20å­—ä»¥ä¸Šã®ã‚¿ã‚¤ãƒˆãƒ«ã¯é•·ã„ãœãˆã€‚çœç•¥ã•...'
      end
    end
```